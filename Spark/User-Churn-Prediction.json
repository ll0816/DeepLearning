{"paragraphs":[{"text":"%dep\nz.reset()\nz.addRepo(\"Spark Packages Repo\").url(\"http://dl.bintray.com/spark-packages/maven\")\nz.load(\"com.databricks:spark-csv_2.10:1.4.0\")","dateUpdated":"2017-04-10T06:56:39+0000","config":{"colWidth":11,"editorMode":"ace/mode/scala","graph":{"mode":"table","height":90,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375178_-1397418158","id":"20170410-052341_195612633","result":{"code":"SUCCESS","type":"TEXT","msg":"DepInterpreter(%dep) deprecated. Remove dependencies and repositories through GUI interpreter menu instead.\nDepInterpreter(%dep) deprecated. Add repository through GUI interpreter menu instead.\nDepInterpreter(%dep) deprecated. Load dependency through GUI interpreter menu instead.\nres0: org.apache.zeppelin.dep.Dependency = org.apache.zeppelin.dep.Dependency@7a202702\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3244","dateFinished":"2017-04-10T06:57:16+0000","dateStarted":"2017-04-10T06:56:41+0000","focus":true},{"text":"%md ## Introduction\nUser Churn Prediction using PySpark\n","dateUpdated":"2017-04-10T06:56:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375217_-1401650396","id":"20170410-052014_197648248","result":{"code":"SUCCESS","type":"HTML","msg":"<h2>Introduction</h2>\n<p>User Churn Prediction using PySpark</p>\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3245"},{"text":"%md ### Part I\nLoad Data as Spark DataFrame","dateUpdated":"2017-04-10T06:56:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375217_-1401650396","id":"20170410-052236_709109831","result":{"code":"SUCCESS","type":"HTML","msg":"<h3>Part I</h3>\n<p>Load Data as Spark DataFrame</p>\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3246"},{"text":"%sh\n\ncd /tmp\n\n# Remove old dataset file if already exists in local /tmp directory\nif [ -e /tmp/churn.all ]\nthen\n    rm -f /tmp/churnall\nfi\n\n# Remove old dataset if already exists in hadoop /tmp directory\nif hadoop fs -stat /tmp/churn.all\nthen\n    hadoop fs -rm /tmp/churn.all\nfi\n\n# Download churn.all file\nwget https://www.sgi.com/tech/mlc/db/churn.all # https://www.dropbox.com/s/rke4iprtedjzq9f/churn.all?dl=0\n\n# Move dataset tp hadf /tmp\nhadoop fs -put churn.all /tmp","dateUpdated":"2017-04-10T07:01:39+0000","config":{"colWidth":12,"editorMode":"ace/mode/sh","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"lineNumbers":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375217_-1401650396","id":"20170410-052415_313245123","result":{"code":"SUCCESS","type":"TEXT","msg":"2017-04-10 07:00:08\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3247","dateFinished":"2017-04-10T07:02:02+0000","dateStarted":"2017-04-10T07:01:39+0000","focus":true},{"text":"%sh\n\nhadoop fs -cat /tmp/churn.all | head","dateUpdated":"2017-04-10T07:02:13+0000","config":{"colWidth":12,"editorMode":"ace/mode/sh","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375218_-1400496149","id":"20170410-053147_2075121980","result":{"code":"SUCCESS","type":"TEXT","msg":"KS, 128, 415, 382-4657, no, yes, 25, 265.1, 110, 45.07, 197.4, 99, 16.78, 244.7, 91, 11.01, 10, 3, 2.7, 1, False.\nOH, 107, 415, 371-7191, no, yes, 26, 161.6, 123, 27.47, 195.5, 103, 16.62, 254.4, 103, 11.45, 13.7, 3, 3.7, 1, False.\nNJ, 137, 415, 358-1921, no, no, 0, 243.4, 114, 41.38, 121.2, 110, 10.3, 162.6, 104, 7.32, 12.2, 5, 3.29, 0, False.\nOH, 84, 408, 375-9999, yes, no, 0, 299.4, 71, 50.9, 61.9, 88, 5.26, 196.9, 89, 8.86, 6.6, 7, 1.78, 2, False.\nOK, 75, 415, 330-6626, yes, no, 0, 166.7, 113, 28.34, 148.3, 122, 12.61, 186.9, 121, 8.41, 10.1, 3, 2.73, 3, False.\nAL, 118, 510, 391-8027, yes, no, 0, 223.4, 98, 37.98, 220.6, 101, 18.75, 203.9, 118, 9.18, 6.3, 6, 1.7, 0, False.\nMA, 121, 510, 355-9993, no, yes, 24, 218.2, 88, 37.09, 348.5, 108, 29.62, 212.6, 118, 9.57, 7.5, 7, 2.03, 3, False.\nMO, 147, 415, 329-9001, yes, no, 0, 157, 79, 26.69, 103.1, 94, 8.76, 211.8, 96, 9.53, 7.1, 6, 1.92, 0, False.\nLA, 117, 408, 335-4719, no, no, 0, 184.5, 97, 31.37, 351.6, 80, 29.89, 215.8, 90, 9.71, 8.7, 4, 2.35, 1, False.\nWV, 141, 415, 330-8173, yes, yes, 37, 258.6, 84, 43.96, 222, 111, 18.87, 326.4, 97, 14.69, 11.2, 5, 3.02, 0, False.\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3248","dateFinished":"2017-04-10T07:02:20+0000","dateStarted":"2017-04-10T07:02:14+0000","focus":true},{"text":"%pyspark\nfrom pyspark.sql import SQLContext\nfrom pyspark.sql.types import *\n\nsqlContext = SQLContext(sc)\nschema = StructType([\\\n    StructField(\"state\", StringType(), True),\\\n    StructField(\"account_length\", DoubleType(), True),\\\n    StructField(\"area_code\", StringType(), True),\\\n    StructField(\"phone_number\", StringType(), True),\\\n    StructField(\"intl_plan\", StringType(), True),\\\n    StructField(\"voice_mail_plan\", StringType(), True),\\\n    StructField(\"number_vmail_messages\", DoubleType(), True),\\\n    StructField(\"total_day_minutes\", DoubleType(), True),\\\n    StructField(\"total_day_calls\", DoubleType(), True),\\\n    StructField(\"total_day_charge\", DoubleType(), True),\\\n    StructField(\"total_eve_minutes\", DoubleType(), True),\\\n    StructField(\"total_eve_calls\", DoubleType(), True),\\\n    StructField(\"total_eve_charge\", DoubleType(), True),\\\n    StructField(\"total_night_minutes\", DoubleType(), True),\\\n    StructField(\"total_night_calls\", DoubleType(), True),\\\n    StructField(\"total_night_charge\", DoubleType(), True),\\\n    StructField(\"total_intl_minutes\", DoubleType(), True),\\\n    StructField(\"total_intl_calls\", DoubleType(), True),\\\n    StructField(\"total_intl_charge\", DoubleType(), True),\\\n    StructField(\"number_customer_service_calls\", DoubleType(), True),\\\n    StructField(\"churned\", StringType(), True)])\n\nchurn_data = sqlContext.read.format(\"com.databricks.spark.csv\").load('/tmp/churn.all', schema = schema, header = \"false\")","dateUpdated":"2017-04-10T07:02:23+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375218_-1400496149","id":"20170410-053311_70982718","result":{"code":"SUCCESS","type":"TEXT","msg":""},"dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3249","dateFinished":"2017-04-10T07:05:03+0000","dateStarted":"2017-04-10T07:02:23+0000","focus":true},{"text":"%pyspark\ncount = churn_data.count()\nprint count\nprint churn_data","dateUpdated":"2017-04-10T07:05:24+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375218_-1400496149","id":"20170410-060224_1619917600","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3250","dateFinished":"2017-04-10T07:05:58+0000","dateStarted":"2017-04-10T07:05:25+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"5000\nDataFrame[state: string, account_length: double, area_code: string, phone_number: string, intl_plan: string, voice_mail_plan: string, number_vmail_messages: double, total_day_minutes: double, total_day_calls: double, total_day_charge: double, total_eve_minutes: double, total_eve_calls: double, total_eve_charge: double, total_night_minutes: double, total_night_calls: double, total_night_charge: double, total_intl_minutes: double, total_intl_calls: double, total_intl_charge: double, number_customer_service_calls: double, churned: string]\n"},"focus":true},{"text":"%md ### Part II: Model training with Spark ML Pipeline","dateUpdated":"2017-04-10T06:56:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375223_-1402419894","id":"20170410-060425_1251959038","result":{"code":"SUCCESS","type":"HTML","msg":"<h3>Part II: Model training with Spark ML Pipeline</h3>\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3251"},{"text":"%pyspark\n\nfrom pyspark.ml.feature import StringIndexer\nfrom pyspark.ml.feature import VectorAssembler\nfrom pyspark.ml import Pipeline\nfrom pyspark.ml.classification import RandomForestClassifier\n\nreduced_numeric_cols = [\"account_length\", \"number_vmail_messages\", \"total_day_minutes\", \"total_day_calls\",\n                        \"total_day_charge\", \"total_eve_minutes\", \"total_eve_calls\", \"total_eve_charge\",\n                        \"total_night_minutes\", \"total_night_calls\", \"total_night_charge\", \"total_intl_minutes\",\n                        \"total_intl_calls\", \"total_intl_charge\", \"number_customer_service_calls\"]\n\nplan_indexer = StringIndexer(inputCol = 'intl_plan', outputCol = 'intl_plan_indexed')\nvoice_plan_indexer = StringIndexer(inputCol = 'voice_mail_plan', outputCol = 'voice_mail_plan_indexed')\nlabel_indexer = StringIndexer(inputCol = \"churned\", outputCol = 'label') #Y\n\nassembler = VectorAssembler(inputCols = ['intl_plan_indexed', 'voice_mail_plan_indexed'] +\\\n                            reduced_numeric_cols, outputCol = 'features') #X\nclassifier = RandomForestClassifier(labelCol = 'label', featuresCol = 'features')\n\npipeline = Pipeline(stages = [plan_indexer, voice_plan_indexer, label_indexer, assembler, classifier])\n\n(train, test) = churn_data.randomSplit([0.8, 0.2])\nmodel = pipeline.fit(train)\npredictions = model.transform(test)","dateUpdated":"2017-04-10T07:06:49+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","lineNumbers":true,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375224_-1404343638","id":"20170410-060550_1748001153","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3252","focus":true,"dateFinished":"2017-04-10T07:06:59+0000","dateStarted":"2017-04-10T07:06:50+0000","result":{"code":"SUCCESS","type":"TEXT","msg":""}},{"text":"%pyspark\nprint label_indexer","dateUpdated":"2017-04-10T07:07:01+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375225_-1404728387","id":"20170410-062642_1611231828","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3253","focus":true,"dateFinished":"2017-04-10T07:07:02+0000","dateStarted":"2017-04-10T07:07:01+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"StringIndexer_49c688a251195a40752b\n"}},{"text":"%pyspark\nprint predictions.take(1)","dateUpdated":"2017-04-10T07:07:04+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375226_-1403574141","id":"20170410-062847_653589393","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3254","dateFinished":"2017-04-10T07:07:06+0000","dateStarted":"2017-04-10T07:07:04+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"[Row(state=u'AK', account_length=59.0, area_code=u' 408', phone_number=u' 416-1845', intl_plan=u' no', voice_mail_plan=u' no', number_vmail_messages=0.0, total_day_minutes=159.5, total_day_calls=96.0, total_day_charge=27.120000000000001, total_eve_minutes=167.19999999999999, total_eve_calls=123.0, total_eve_charge=14.210000000000001, total_night_minutes=138.59999999999999, total_night_calls=106.0, total_night_charge=6.2400000000000002, total_intl_minutes=10.199999999999999, total_intl_calls=4.0, total_intl_charge=2.75, number_customer_service_calls=0.0, churned=u' False.', intl_plan_indexed=0.0, voice_mail_plan_indexed=0.0, label=0.0, features=DenseVector([0.0, 0.0, 59.0, 0.0, 159.5, 96.0, 27.12, 167.2, 123.0, 14.21, 138.6, 106.0, 6.24, 10.2, 4.0, 2.75, 0.0]), rawPrediction=DenseVector([19.255, 0.745]), probability=DenseVector([0.9628, 0.0372]), prediction=0.0)]\n"},"focus":true},{"text":"%pyspark\nprint dir(predictions)","dateUpdated":"2017-04-10T07:07:07+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375226_-1403574141","id":"20170410-063445_1213137428","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3255","focus":true,"dateFinished":"2017-04-10T07:07:08+0000","dateStarted":"2017-04-10T07:07:08+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"['__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattr__', '__getattribute__', '__getitem__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_jcols', '_jdf', '_jmap', '_jseq', '_lazy_rdd', '_sc', '_schema', '_sort_cols', 'agg', 'alias', 'cache', 'coalesce', 'collect', 'columns', 'corr', 'count', 'cov', 'crosstab', 'cube', 'describe', 'distinct', 'drop', 'dropDuplicates', 'drop_duplicates', 'dropna', 'dtypes', 'explain', 'fillna', 'filter', 'first', 'flatMap', 'foreach', 'foreachPartition', 'freqItems', 'groupBy', 'groupby', 'head', 'insertInto', 'intersect', 'isLocal', 'is_cached', 'join', 'limit', 'map', 'mapPartitions', 'na', 'orderBy', 'persist', 'printSchema', 'randomSplit', 'rdd', 'registerAsTable', 'registerTempTable', 'repartition', 'replace', 'rollup', 'sample', 'sampleBy', 'save', 'saveAsParquetFile', 'saveAsTable', 'schema', 'select', 'selectExpr', 'show', 'sort', 'sortWithinPartitions', 'sql_ctx', 'stat', 'subtract', 'take', 'toDF', 'toJSON', 'toPandas', 'unionAll', 'unpersist', 'where', 'withColumn', 'withColumnRenamed', 'write']\n"}},{"text":"%md ### Part III: Result Evalution","dateUpdated":"2017-04-10T06:56:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/markdown","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375227_-1403958889","id":"20170410-062920_399861129","result":{"code":"SUCCESS","type":"HTML","msg":"<h3>Part III: Result Evalution</h3>\n"},"dateCreated":"2017-04-10T06:56:15+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3256"},{"text":"%pyspark\nfrom pyspark.mllib.evaluation import MulticlassMetrics\n\npredictionAndLabels = predictions.select(\"label\", \"prediction\").map(lambda lp: (lp.prediction, lp.label))\n\nmetrics = MulticlassMetrics(predictionAndLabels)\n\nprecision = metrics.precision(1.0)\nrecall = metrics.recall(1.0)\nf1Score = metrics.fMeasure(1.0)\n\nprint(\"Summary Stats\")\nprint(\"Precision - %s\" % precision)\nprint(\"Recall = %s\" % recall)\nprint(\"F1 Score = %s\" % f1Score)","dateUpdated":"2017-04-10T07:07:12+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375227_-1403958889","id":"20170410-063006_2023165383","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3257","dateFinished":"2017-04-10T07:07:16+0000","dateStarted":"2017-04-10T07:07:12+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"Summary Stats\nPrecision - 0.941176470588\nRecall = 0.474074074074\nF1 Score = 0.630541871921\n"},"focus":true},{"text":"%pyspark\nprint predictions.select(\"probability\").show(10)","dateUpdated":"2017-04-10T07:07:21+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375236_-1322776872","id":"20170410-063840_1835458120","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3258","dateFinished":"2017-04-10T07:07:22+0000","dateStarted":"2017-04-10T07:07:21+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"+--------------------+\n|         probability|\n+--------------------+\n|[0.96275213419479...|\n|[0.93667840760161...|\n|[0.94677254134693...|\n|[0.96342567741194...|\n|[0.89127202736537...|\n|[0.96617724244603...|\n|[0.89408910002274...|\n|[0.96444397353974...|\n|[0.86463637989851...|\n|[0.92446596007717...|\n+--------------------+\nonly showing top 10 rows\n\nNone\n"},"focus":true},{"text":"%pyspark\nfrom pyspark.ml.evaluation import BinaryClassificationEvaluator\n\nevaluator = BinaryClassificationEvaluator()\nauroc = evaluator.evaluate(predictions, {evaluator.metricName: \"areaUnderROC\"})\nprint \"The AUROC is %s\" % round(auroc, 2)","dateUpdated":"2017-04-10T07:08:00+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375237_-1323161620","id":"20170410-064104_277343676","dateCreated":"2017-04-10T06:56:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3259","dateFinished":"2017-04-10T07:08:02+0000","dateStarted":"2017-04-10T07:08:00+0000","result":{"code":"SUCCESS","type":"TEXT","msg":"The AUROC is 0.91\n"},"focus":true},{"dateUpdated":"2017-04-10T06:56:15+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1491807375238_-1322007374","id":"20170410-064314_599675307","dateCreated":"2017-04-10T06:56:15+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3260"}],"name":"User-Churn-Prediction","id":"2CEQ38C1N","angularObjects":{"2BYG9GAN3:shared_process":[],"2C139U1BG:shared_process":[],"2BYWWZJPK:shared_process":[],"2C2VAKPN2:shared_process":[],"2BZC2RPUW:shared_process":[],"2BZQEH9EH:shared_process":[]},"config":{"looknfeel":"default"},"info":{}}